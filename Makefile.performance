# Claude Relay Service - Performance Testing & Monitoring Makefile
# æ€§èƒ½æµ‹è¯•å’Œç›‘æ§çš„ä¾¿æ·å‘½ä»¤é›†åˆ

.PHONY: help performance-quick performance-full monitoring-setup monitoring-start monitoring-test clean-reports

# é»˜è®¤ç›®æ ‡
help:
	@echo "Claude Relay Service - Performance & Monitoring Commands"
	@echo "========================================================="
	@echo ""
	@echo "Quick Performance Checks:"
	@echo "  performance-quick     - Run quick performance check (< 2 min)"
	@echo "  performance-health    - Alias for performance-quick"
	@echo ""
	@echo "Full Performance Tests:"
	@echo "  performance-full      - Run complete performance benchmark suite"
	@echo "  performance-load      - Test load balancer performance only"
	@echo "  performance-error     - Test error handling performance only"
	@echo "  performance-conn      - Test connection manager performance only"
	@echo "  performance-session   - Test session manager performance only"
	@echo "  performance-concurrent - Test concurrent load performance only"
	@echo ""
	@echo "Monitoring Commands:"
	@echo "  monitoring-setup      - Setup complete monitoring system"
	@echo "  monitoring-start      - Start monitoring system (background)"
	@echo "  monitoring-test       - Test monitoring system functionality"
	@echo "  monitoring-stop       - Stop monitoring system"
	@echo ""
	@echo "Utilities:"
	@echo "  clean-reports         - Clean up old performance reports"
	@echo "  install-deps          - Install performance testing dependencies"
	@echo "  check-system          - Check system requirements"
	@echo ""

# å¿«é€Ÿæ€§èƒ½æ£€æŸ¥
performance-quick:
	@echo "ğŸš€ Running Quick Performance Check..."
	@node scripts/quick-performance-check.js

performance-health: performance-quick

# å®Œæ•´æ€§èƒ½æµ‹è¯•
performance-full:
	@echo "ğŸš€ Running Full Performance Benchmark Suite..."
	@echo "âš ï¸  This may take 30+ minutes to complete"
	@node scripts/performance-benchmark.js full

performance-load:
	@echo "ğŸ§  Testing Load Balancer Performance..."
	@node scripts/performance-benchmark.js load-balancer

performance-error:
	@echo "ğŸ”¥ Testing Error Handling Performance..."
	@node scripts/performance-benchmark.js error-handling

performance-conn:
	@echo "ğŸ”— Testing Connection Manager Performance..."
	@node scripts/performance-benchmark.js connection-manager

performance-session:
	@echo "ğŸ“ Testing Session Manager Performance..."
	@node scripts/performance-benchmark.js session-manager

performance-concurrent:
	@echo "ğŸ’ª Testing Concurrent Load Performance..."
	@node scripts/performance-benchmark.js concurrent

# ç›‘æ§ç³»ç»Ÿå‘½ä»¤
monitoring-setup:
	@echo "ğŸ“Š Setting up Complete Monitoring System..."
	@node scripts/monitoring-setup.js setup

monitoring-start:
	@echo "ğŸš€ Starting Monitoring System..."
	@echo "ğŸ’¡ Use 'make monitoring-stop' to stop the monitoring system"
	@nohup node scripts/monitoring-setup.js start > logs/monitoring.log 2>&1 &
	@echo "âœ… Monitoring system started in background"
	@echo "ğŸ“‹ Check logs/monitoring.log for output"

monitoring-test:
	@echo "ğŸ§ª Testing Monitoring System..."
	@node scripts/monitoring-setup.js test

monitoring-stop:
	@echo "ğŸ›‘ Stopping Monitoring System..."
	@pkill -f "monitoring-setup.js" || true
	@echo "âœ… Monitoring system stopped"

# å·¥å…·å‘½ä»¤
clean-reports:
	@echo "ğŸ§¹ Cleaning up old performance reports..."
	@rm -rf temp/performance-reports/*
	@echo "âœ… Performance reports cleaned"

install-deps:
	@echo "ğŸ“¦ Installing performance testing dependencies..."
	@npm install --save-dev
	@echo "âœ… Dependencies installed"

check-system:
	@echo "ğŸ” Checking System Requirements..."
	@echo "Node.js version: $$(node --version)"
	@echo "NPM version: $$(npm --version)"
	@echo "Redis status: $$(redis-cli ping 2>/dev/null || echo 'NOT RUNNING')"
	@echo "Available memory: $$(free -h 2>/dev/null | grep Mem || echo 'N/A (non-Linux)')"
	@echo "Disk space: $$(df -h . | tail -1 | awk '{print $$4}' || echo 'N/A')"

# å¼€å‘å’Œè°ƒè¯•å‘½ä»¤
debug-performance:
	@echo "ğŸ› Running Performance Benchmark in Debug Mode..."
	@NODE_ENV=development node --inspect scripts/performance-benchmark.js full

debug-monitoring:
	@echo "ğŸ› Running Monitoring Setup in Debug Mode..."
	@NODE_ENV=development node --inspect scripts/monitoring-setup.js test

# è‡ªåŠ¨åŒ–ä»»åŠ¡
cron-setup:
	@echo "â° Setting up cron jobs for automated performance checks..."
	@echo "# Claude Relay Service - Automated Performance Checks" > /tmp/claude-cron
	@echo "# Daily performance check at 2 AM" >> /tmp/claude-cron
	@echo "0 2 * * * cd $(PWD) && make performance-quick >> logs/daily-performance.log 2>&1" >> /tmp/claude-cron
	@echo "# Weekly full benchmark on Sunday at 3 AM" >> /tmp/claude-cron
	@echo "0 3 * * 0 cd $(PWD) && make performance-full >> logs/weekly-performance.log 2>&1" >> /tmp/claude-cron
	@crontab /tmp/claude-cron
	@rm /tmp/claude-cron
	@echo "âœ… Cron jobs set up successfully"
	@echo "ğŸ“‹ View with: crontab -l"

cron-remove:
	@echo "âŒ Removing automated performance cron jobs..."
	@crontab -l | grep -v "Claude Relay Service" | crontab -
	@echo "âœ… Cron jobs removed"

# CI/CD é›†æˆå‘½ä»¤
ci-performance:
	@echo "ğŸ¤– Running CI Performance Check..."
	@make performance-quick
	@if [ $$? -eq 0 ]; then \
		echo "âœ… Performance check passed"; \
	else \
		echo "âŒ Performance check failed"; \
		exit 1; \
	fi

ci-monitoring:
	@echo "ğŸ¤– Running CI Monitoring Test..."
	@make monitoring-test
	@echo "âœ… Monitoring test completed"

# æŠ¥å‘Šç”Ÿæˆ
report-html:
	@echo "ğŸ“Š Generating HTML Performance Report..."
	@if [ -d "temp/performance-reports" ]; then \
		latest_dir=$$(ls -t temp/performance-reports/ | head -1); \
		if [ -f "temp/performance-reports/$$latest_dir/performance-report.html" ]; then \
			echo "ğŸ“‹ Latest HTML report: temp/performance-reports/$$latest_dir/performance-report.html"; \
			if command -v open >/dev/null 2>&1; then \
				open "temp/performance-reports/$$latest_dir/performance-report.html"; \
			elif command -v xdg-open >/dev/null 2>&1; then \
				xdg-open "temp/performance-reports/$$latest_dir/performance-report.html"; \
			else \
				echo "ğŸ“ Open manually: temp/performance-reports/$$latest_dir/performance-report.html"; \
			fi; \
		else \
			echo "âŒ No HTML report found. Run 'make performance-full' first."; \
		fi; \
	else \
		echo "âŒ No performance reports found. Run 'make performance-full' first."; \
	fi

report-csv:
	@echo "ğŸ“Š Finding Latest CSV Performance Report..."
	@if [ -d "temp/performance-reports" ]; then \
		latest_dir=$$(ls -t temp/performance-reports/ | head -1); \
		if [ -f "temp/performance-reports/$$latest_dir/performance-metrics.csv" ]; then \
			echo "ğŸ“‹ Latest CSV report: temp/performance-reports/$$latest_dir/performance-metrics.csv"; \
			head -20 "temp/performance-reports/$$latest_dir/performance-metrics.csv"; \
		else \
			echo "âŒ No CSV report found. Run 'make performance-full' first."; \
		fi; \
	else \
		echo "âŒ No performance reports found. Run 'make performance-full' first."; \
	fi

# æ€§èƒ½è¶‹åŠ¿åˆ†æ
trend-analysis:
	@echo "ğŸ“ˆ Analyzing Performance Trends..."
	@if [ -d "temp/performance-reports" ]; then \
		echo "ğŸ“Š Performance report history:"; \
		ls -la temp/performance-reports/ | grep ^d | tail -10; \
		echo "ğŸ“ˆ Use 'make report-html' to view the latest detailed report"; \
	else \
		echo "âŒ No historical data found. Run performance tests first."; \
	fi

# å¸®åŠ©å‘½ä»¤
help-performance:
	@echo "Performance Testing Help"
	@echo "========================"
	@echo ""
	@echo "Quick Start:"
	@echo "  1. Run 'make performance-quick' for a fast health check"
	@echo "  2. Run 'make performance-full' for comprehensive testing"
	@echo "  3. Run 'make monitoring-setup' to enable monitoring"
	@echo ""
	@echo "Interpreting Results:"
	@echo "  â€¢ Green (âœ…): Excellent performance"
	@echo "  â€¢ Yellow (âš ï¸): Warning - needs attention"
	@echo "  â€¢ Red (âŒ): Critical - immediate action required"
	@echo ""
	@echo "Thresholds:"
	@echo "  â€¢ Load Balancer: < 50ms account selection"
	@echo "  â€¢ Error Handling: < 100ms retry overhead"
	@echo "  â€¢ Connections: < 2s establishment, > 90% reuse"
	@echo "  â€¢ Sessions: < 10ms creation, < 50ms restore"
	@echo ""

help-monitoring:
	@echo "Monitoring System Help"
	@echo "======================"
	@echo ""
	@echo "Setup Process:"
	@echo "  1. Run 'make monitoring-setup' (one-time setup)"
	@echo "  2. Run 'make monitoring-start' (start background monitoring)"
	@echo "  3. Access monitoring data via API endpoints"
	@echo ""
	@echo "API Endpoints:"
	@echo "  â€¢ GET /api/monitoring/metrics/realtime"
	@echo "  â€¢ GET /api/monitoring/alerts"
	@echo "  â€¢ GET /api/monitoring/dashboard/overview"
	@echo "  â€¢ GET /api/monitoring/health"
	@echo ""
	@echo "Data Storage:"
	@echo "  â€¢ Real-time metrics: Redis (1 hour TTL)"
	@echo "  â€¢ Historical data: Redis (24 hours TTL)"
	@echo "  â€¢ Alert history: Redis (7 days TTL)"
	@echo ""

# é«˜çº§å‘½ä»¤ç»„åˆ
full-health-check: performance-quick monitoring-test
	@echo "ğŸ¥ Full Health Check Completed"

deploy-check: check-system install-deps performance-quick
	@echo "ğŸš€ Deployment Readiness Check Completed"

production-setup: monitoring-setup cron-setup
	@echo "ğŸ­ Production Setup Completed"
	@echo "âœ… Monitoring system configured"
	@echo "âœ… Automated checks scheduled"

# æ•…éšœæ’é™¤
troubleshoot:
	@echo "ğŸ”§ Running Troubleshooting Diagnostics..."
	@echo ""
	@echo "1. System Status:"
	@make check-system
	@echo ""
	@echo "2. Log Files:"
	@if [ -f "logs/claude-relay-error.log" ]; then \
		echo "ğŸ“‹ Recent errors:"; \
		tail -10 logs/claude-relay-error.log; \
	else \
		echo "âœ… No error log found"; \
	fi
	@echo ""
	@echo "3. Performance Status:"
	@make performance-quick || echo "âŒ Performance check failed"
	@echo ""
	@echo "4. Monitoring Status:"
	@make monitoring-test || echo "âŒ Monitoring test failed"

# æ¸…ç†å‘½ä»¤
clean-all: clean-reports
	@echo "ğŸ§¹ Cleaning all temporary files..."
	@rm -rf logs/monitoring.log
	@rm -rf logs/daily-performance.log
	@rm -rf logs/weekly-performance.log
	@echo "âœ… All temporary files cleaned"

# æ–‡æ¡£ç”Ÿæˆ
docs:
	@echo "ğŸ“š Performance & Monitoring Documentation:"
	@echo "  ğŸ“– Main Guide: docs/PERFORMANCE_MONITORING_GUIDE.md"
	@echo "  ğŸš€ Quick Start: make help"
	@echo "  ğŸ”§ Troubleshooting: make troubleshoot"
	@echo "  ğŸ“Š Latest Reports: make report-html"