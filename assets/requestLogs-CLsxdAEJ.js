import{aR as k,r as n,c as b}from"./vue-vendor-Ig-GgGwA.js";import{b as c}from"./index-4H_hOmbg.js";import{s as a}from"./toast-BvwA7Mwb.js";const H=k("requestLogs",()=>{const i=n([]),u=n(!1),m=n(!1),w=n({totalRequests:0,errorRate:0,averageResponseTime:0,topApiKeys:[]}),o=n({apiKeyId:"",startDate:"",endDate:"",statusCode:"",method:"",search:"",page:1,limit:50,sortBy:"timestamp",sortOrder:"desc"}),p=n({page:1,limit:50,total:0,totalPages:0}),d=n({enabled:!1,mode:"performance",sampling:{successRate:.1,errorRate:1,slowRequestThreshold:5e3},retention:{days:30,maxEntries:1e5},async:{batchSize:50,flushInterval:2e3}}),h=n(!1),y=n(!1),D=b(()=>{if(!o.value.search)return i.value;const e=o.value.search.toLowerCase();return i.value.filter(t=>{var s,r,g,f,l,R,F,B;return((r=(s=t.apiKey)==null?void 0:s.name)==null?void 0:r.toLowerCase().includes(e))||((f=(g=t.request)==null?void 0:g.userAgent)==null?void 0:f.toLowerCase().includes(e))||((R=(l=t.request)==null?void 0:l.ip)==null?void 0:R.includes(e))||((B=(F=t.request)==null?void 0:F.path)==null?void 0:B.toLowerCase().includes(e))})}),P=b(()=>{const e=o.value;return e.apiKeyId||e.startDate||e.endDate||e.statusCode||e.method||e.search}),v=async(e={})=>{u.value=!0;try{const t={...o.value,...e},s=await c.get("/admin/request-logs",{params:t});return s&&s.success&&(i.value=s.data.logs||[],p.value={page:s.data.page||1,limit:s.data.limit||50,total:s.data.total||0,totalPages:s.data.totalPages||0}),s}catch(t){throw console.error("Failed to fetch request logs:",t),a("获取请求日志失败","error"),t}finally{u.value=!1}},T=async(e,t={})=>{u.value=!0;try{const s={...t},r=await c.get(`/admin/request-logs/${e}`,{params:s});return r&&r.success&&(i.value=r.data.logs||[],p.value=r.data.pagination||{}),r}catch(s){throw console.error("Failed to fetch API key logs:",s),a("获取API Key日志失败","error"),s}finally{u.value=!1}},x=async(e="24h")=>{try{const t=await c.get("/admin/request-logs/stats",{params:{timeRange:e}});return t&&t.success&&(w.value=t.data||{}),t}catch(t){throw console.error("Failed to fetch log stats:",t),a("获取统计信息失败","error"),t}},K=async e=>{try{const t=await c.delete(`/admin/request-logs/${e}`);return t&&t.success&&(a("日志删除成功","success"),await v()),t}catch(t){throw console.error("Failed to delete logs:",t),a("删除日志失败","error"),t}},S=async(e="json",t={})=>{m.value=!0;try{const s={format:e,...o.value,...t},r=await c.post("/admin/request-logs/export",s);if(r&&r.success){const g=new Blob([r.data.content],{type:e==="csv"?"text/csv":"application/json"}),f=window.URL.createObjectURL(g),l=document.createElement("a");l.href=f,l.download=r.data.filename||`request-logs-${new Date().getTime()}.${e}`,document.body.appendChild(l),l.click(),document.body.removeChild(l),window.URL.revokeObjectURL(f),a(`日志已导出为 ${e.toUpperCase()} 格式`,"success")}return r}catch(s){throw console.error("Failed to export logs:",s),a("导出日志失败","error"),s}finally{m.value=!1}},$=async()=>{h.value=!0;try{const e=await c.get("/admin/request-logs/config");return e&&e.success&&(d.value={...d.value,...e.data}),e}catch(e){throw console.error("Failed to load request logging config:",e),a("加载配置失败","error"),e}finally{h.value=!1}},q=async e=>{y.value=!0;try{const t=await c.put("/admin/request-logs/config",e);return t&&t.success&&(d.value={...d.value,...t.data},a("配置保存成功","success")),t}catch(t){throw console.error("Failed to save request logging config:",t),a("保存配置失败","error"),t}finally{y.value=!1}},A=async()=>await q({enabled:!1,mode:"performance",sampling:{successRate:.1,errorRate:1,slowRequestThreshold:5e3},retention:{days:30,maxEntries:1e5},async:{batchSize:50,flushInterval:2e3}}),E=e=>{o.value={...o.value,...e}},I=()=>{o.value={apiKeyId:"",startDate:"",endDate:"",statusCode:"",method:"",search:"",page:1,limit:50,sortBy:"timestamp",sortOrder:"desc"}},M=async()=>{await v(),await x()},U=e=>{var t,s,r;return{...e,timestamp:new Date(e.timestamp).toLocaleString("zh-CN"),duration:(t=e.response)!=null&&t.duration?`${e.response.duration}ms`:"N/A",statusClass:L((s=e.response)==null?void 0:s.statusCode),methodClass:C((r=e.request)==null?void 0:r.method)}},L=e=>e?e>=200&&e<300?"text-green-600":e>=300&&e<400?"text-yellow-600":e>=400&&e<500?"text-orange-600":e>=500?"text-red-600":"text-gray-500":"text-gray-500",C=e=>({GET:"text-blue-600",POST:"text-green-600",PUT:"text-yellow-600",DELETE:"text-red-600",PATCH:"text-purple-600"})[e]||"text-gray-600";return{logs:i,loading:u,exporting:m,stats:w,filters:o,pagination:p,config:d,configLoading:h,configSaving:y,filteredLogs:D,hasFilters:P,fetchLogs:v,fetchLogsByApiKey:T,fetchStats:x,deleteLogsByApiKey:K,exportLogs:S,refreshLogs:M,loadConfig:$,saveConfig:q,resetConfig:A,updateFilters:E,clearFilters:I,formatLogEntry:U,getStatusClass:L,getMethodClass:C,formatBytes:e=>{if(e===0)return"0 B";const t=1024,s=["B","KB","MB","GB"],r=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,r)).toFixed(2))+" "+s[r]},formatDuration:e=>e<1e3?`${e}ms`:e<6e4?`${(e/1e3).toFixed(1)}s`:`${(e/6e4).toFixed(1)}m`}});export{H as u};
