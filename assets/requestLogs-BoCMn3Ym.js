import{aR as z,r as l,c as K}from"./vue-vendor-Ig-GgGwA.js";import{b as u}from"./index-Dk-v_r93.js";import{s as o}from"./toast-BvwA7Mwb.js";const V=z("requestLogs",()=>{const g=l([]),p=l(!1),x=l(!1),P=l({totalRequests:0,errorRate:0,averageResponseTime:0,topApiKeys:[]}),c=l({apiKeyId:"",startDate:"",endDate:"",statusCode:"",method:"",search:"",page:1,limit:50,sortBy:"timestamp",sortOrder:"desc"}),q=l({page:1,limit:50,total:0,totalPages:0}),m=l({enabled:!1,mode:"performance",sampling:{successRate:.1,errorRate:1,slowRequestThreshold:5e3},retention:{days:30,maxEntries:1e5},async:{batchSize:50,flushInterval:2e3}}),C=l(!1),L=l(!1),T=K(()=>{const e=Array.isArray(g.value)?g.value:[];if(!c.value.search)return e;const t=c.value.search.toLowerCase();return e.filter(s=>{var a,r,n,h,d,y,w,v;return((r=(a=s.apiKey)==null?void 0:a.name)==null?void 0:r.toLowerCase().includes(t))||((h=(n=s.request)==null?void 0:n.userAgent)==null?void 0:h.toLowerCase().includes(t))||((y=(d=s.request)==null?void 0:d.ip)==null?void 0:y.includes(t))||((v=(w=s.request)==null?void 0:w.path)==null?void 0:v.toLowerCase().includes(t))})}),B=K(()=>{const e=c.value;return e.apiKeyId||e.startDate||e.endDate||e.statusCode||e.method||e.search}),b=async(e={})=>{p.value=!0;try{const t={...c.value,...e},s={...t,keyId:t.apiKeyId,status:t.statusCode,search:void 0,apiKeyId:void 0,statusCode:void 0};Object.keys(s).forEach(r=>{(s[r]===void 0||s[r]==="")&&delete s[r]});const a=await u.get("/admin/request-logs",{params:s});return a&&a.success&&a.data&&(g.value=a.data.logs||[],q.value={page:a.data.page||1,limit:a.data.limit||50,total:a.data.total||0,totalPages:a.data.totalPages||0}),a}catch(t){throw console.error("Failed to fetch request logs:",t),o("获取请求日志失败","error"),t}finally{p.value=!1}},A=async(e,t={})=>{p.value=!0;try{const s={...t},a=await u.get(`/admin/request-logs/${e}`,{params:s});return a&&a.success&&a.data&&(g.value=a.data.logs||[],q.value={page:a.data.page||1,limit:a.data.limit||50,total:a.data.total||0,totalPages:a.data.totalPages||0}),a}catch(s){throw console.error("Failed to fetch API key logs:",s),o("获取API Key日志失败","error"),s}finally{p.value=!1}},R=async(e="24h")=>{try{const t=await u.get("/admin/request-logs/stats",{params:{timeRange:e}});return t&&t.success&&(P.value=t.data||{}),t}catch(t){throw console.error("Failed to fetch log stats:",t),o("获取统计信息失败","error"),t}},E=async e=>{try{const t=await u.delete(`/admin/request-logs/${e}`);return t&&t.success&&(o("日志删除成功","success"),await b()),t}catch(t){throw console.error("Failed to delete logs:",t),o("删除日志失败","error"),t}},$=async(e="json",t={})=>{var s,a;x.value=!0;try{const r={...c.value,...t},n={format:e,...r,keyId:r.apiKeyId,status:r.statusCode,search:void 0,apiKeyId:void 0,statusCode:void 0};Object.keys(n).forEach(i=>{(n[i]===void 0||n[i]==="")&&delete n[i]}),o(`正在导出日志为 ${e.toUpperCase()} 格式...`,"info");const h=await u.get("/admin/request-logs/export",{params:n,responseType:"blob"});let d=`request-logs-${new Date().getTime()}.${e}`;const y=(a=(s=h.headers)==null?void 0:s.get)==null?void 0:a.call(s,"Content-Disposition");if(y){const i=y.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);i&&i[1]&&(d=i[1].replace(/['"]/g,""))}const w=h.data,v=window.URL.createObjectURL(w),f=document.createElement("a");return f.href=v,f.download=d,f.style.display="none",document.body.appendChild(f),f.click(),document.body.removeChild(f),window.URL.revokeObjectURL(v),o(`日志已成功导出为 ${e.toUpperCase()} 格式`,"success"),{success:!0,filename:d}}catch(r){console.error("Failed to export logs:",r);const n=r.message||"导出日志失败";throw o(n,"error"),r}finally{x.value=!1}},S=async()=>{C.value=!0;try{const e=await u.get("/admin/request-logs/config");return e&&e.success&&(m.value={...m.value,...e.data}),e}catch(e){throw console.error("Failed to load request logging config:",e),o("加载配置失败","error"),e}finally{C.value=!1}},F=async e=>{L.value=!0;try{const t=await u.put("/admin/request-logs/config",e);return t&&t.success&&(m.value={...m.value,...t.data},o("配置保存成功","success")),t}catch(t){throw console.error("Failed to save request logging config:",t),o("保存配置失败","error"),t}finally{L.value=!1}},M=async()=>await F({enabled:!1,mode:"performance",sampling:{successRate:.1,errorRate:1,slowRequestThreshold:5e3},retention:{days:30,maxEntries:1e5},async:{batchSize:50,flushInterval:2e3}}),O=e=>{c.value={...c.value,...e}},U=()=>{c.value={apiKeyId:"",startDate:"",endDate:"",statusCode:"",method:"",search:"",page:1,limit:50,sortBy:"timestamp",sortOrder:"desc"}},k=async()=>{await b(),await R()},j=e=>{var t,s,a;return{...e,timestamp:new Date(e.timestamp).toLocaleString("zh-CN"),duration:(t=e.response)!=null&&t.duration?`${e.response.duration}ms`:"N/A",statusClass:D((s=e.response)==null?void 0:s.statusCode),methodClass:I((a=e.request)==null?void 0:a.method)}},D=e=>e?e>=200&&e<300?"text-green-600":e>=300&&e<400?"text-yellow-600":e>=400&&e<500?"text-orange-600":e>=500?"text-red-600":"text-gray-500":"text-gray-500",I=e=>({GET:"text-blue-600",POST:"text-green-600",PUT:"text-yellow-600",DELETE:"text-red-600",PATCH:"text-purple-600"})[e]||"text-gray-600";return{logs:g,loading:p,exporting:x,stats:P,filters:c,pagination:q,config:m,configLoading:C,configSaving:L,filteredLogs:T,hasFilters:B,fetchLogs:b,fetchLogsByApiKey:A,fetchStats:R,deleteLogsByApiKey:E,exportLogs:$,refreshLogs:k,loadConfig:S,saveConfig:F,resetConfig:M,updateFilters:O,clearFilters:U,formatLogEntry:j,getStatusClass:D,getMethodClass:I,formatBytes:e=>{if(e===0)return"0 B";const t=1024,s=["B","KB","MB","GB"],a=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,a)).toFixed(2))+" "+s[a]},formatDuration:e=>e<1e3?`${e}ms`:e<6e4?`${(e/1e3).toFixed(1)}s`:`${(e/6e4).toFixed(1)}m`}});export{V as u};
