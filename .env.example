# 🚀 Claude Relay Service Configuration

# 🌐 服务器配置
PORT=3000
HOST=0.0.0.0
NODE_ENV=production

# 🔐 安全配置
JWT_SECRET=your-jwt-secret-here
ADMIN_SESSION_TIMEOUT=86400000
API_KEY_PREFIX=cr_
ENCRYPTION_KEY=your-encryption-key-here

# 👤 管理员凭据（可选，不设置则自动生成）
# ADMIN_USERNAME=cr_admin_custom
# ADMIN_PASSWORD=your-secure-password

# 🗄️ 数据库配置 (Database Configuration)
# 数据库类型选择：redis, mongodb, postgresql, mysql
# Database type selection: redis, mongodb, postgresql, mysql
DATABASE_TYPE=redis

# 📊 Redis 配置（当前默认数据库）
# Redis Configuration (Current Default Database)
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0
REDIS_ENABLE_TLS=

# 🎯 Claude API 配置
CLAUDE_API_URL=https://api.anthropic.com/v1/messages
CLAUDE_API_VERSION=2023-06-01
CLAUDE_BETA_HEADER=claude-code-20250219,oauth-2025-04-20,interleaved-thinking-2025-05-14,fine-grained-tool-streaming-2025-05-14

# 🔷 Azure OpenAI API 配置
# ================================================================
# 主功能开关 - Master Azure OpenAI toggle
AZURE_OPENAI_ENABLED=false                                    # 启用Azure OpenAI功能 (默认禁用)

# API版本配置 - API Version Configuration
AZURE_OPENAI_DEFAULT_API_VERSION=2024-10-21                   # 默认API版本
AZURE_OPENAI_CHAT_API_VERSION=2024-10-21                      # 聊天API版本
AZURE_OPENAI_EMBEDDINGS_API_VERSION=2024-02-01                # 嵌入API版本
AZURE_OPENAI_RESPONSES_API_VERSION=2024-10-01-preview         # 响应API版本（预览版）

# 默认模型配置 - Default Model Configuration
AZURE_OPENAI_DEFAULT_CHAT_MODEL=gpt-4o                        # 默认聊天模型
AZURE_OPENAI_DEFAULT_EMBEDDING_MODEL=text-embedding-3-small   # 默认嵌入模型
AZURE_OPENAI_FALLBACK_CHAT_MODEL=gpt-35-turbo                 # 后备聊天模型

# 请求配置 - Request Configuration
AZURE_OPENAI_REQUEST_TIMEOUT=600000                           # 请求超时时间(毫秒) - 10分钟
AZURE_OPENAI_MAX_RETRIES=3                                     # 最大重试次数
AZURE_OPENAI_RETRY_DELAY=1000                                  # 重试延迟(毫秒)
AZURE_OPENAI_MAX_TOKENS_LIMIT=150000                           # Token使用限制
AZURE_OPENAI_ENABLE_KEEP_ALIVE=true                            # 启用连接保活
AZURE_OPENAI_MAX_REDIRECTS=5                                   # 最大重定向次数

# 安全配置 - Security Configuration
AZURE_OPENAI_ENCRYPTION_SALT=azure-openai-account-default-salt # 加密盐值
AZURE_OPENAI_KEY_ROTATION_INTERVAL=86400000                    # 密钥轮换间隔(毫秒) - 24小时
AZURE_OPENAI_ENABLE_API_KEY_MASKING=true                       # 启用API Key遮掩

# 健康检查配置 - Health Check Configuration
AZURE_OPENAI_HEALTH_CHECK_ENABLED=true                         # 启用健康检查
AZURE_OPENAI_HEALTH_CHECK_INTERVAL=300000                      # 健康检查间隔(毫秒) - 5分钟
AZURE_OPENAI_HEALTH_CHECK_TIMEOUT=10000                        # 健康检查超时(毫秒) - 10秒
AZURE_OPENAI_HEALTH_CHECK_API_TEST=false                       # 启用API连接测试
AZURE_OPENAI_HEALTH_CHECK_PARALLEL=true                        # 并行健康检查

# 使用统计和监控配置 - Monitoring Configuration
AZURE_OPENAI_ENABLE_USAGE_TRACKING=true                        # 启用使用统计
AZURE_OPENAI_ENABLE_PERFORMANCE_METRICS=false                  # 启用性能指标
AZURE_OPENAI_USAGE_RETENTION_DAYS=90                           # 使用数据保留天数
AZURE_OPENAI_METRICS_INTERVAL=60000                            # 指标收集间隔(毫秒) - 1分钟

# 负载均衡和调度配置 - Load Balancing Configuration
AZURE_OPENAI_LOAD_BALANCING_STRATEGY=least_recent              # 负载均衡策略
AZURE_OPENAI_ENABLE_ACCOUNT_ROTATION=true                      # 启用账户轮换
AZURE_OPENAI_MAX_ACCOUNT_USAGE=1000000                         # 账户最大使用量
AZURE_OPENAI_SESSION_STICKINESS_TIMEOUT=3600                   # 会话粘性超时(秒) - 1小时

# 费用管理配置 - Cost Management Configuration
AZURE_OPENAI_ENABLE_COST_TRACKING=true                         # 启用费用跟踪
AZURE_OPENAI_COST_CURRENCY=USD                                 # 费用货币单位
AZURE_OPENAI_ENABLE_BUDGET_ALERTS=false                        # 启用预算警报
AZURE_OPENAI_DEFAULT_BUDGET_LIMIT=100.0                        # 默认预算限制($)
AZURE_OPENAI_COST_PRECISION=6                                  # 费用计算精度(小数位)

# 流式响应配置 - Streaming Configuration
AZURE_OPENAI_STREAM_MAX_BUFFER_SIZE=65536                      # 流最大缓冲区大小(字节) - 64KB
AZURE_OPENAI_STREAM_MAX_EVENT_SIZE=16384                       # 流最大事件大小(字节) - 16KB
AZURE_OPENAI_STREAM_MAX_EVENTS=10000                           # 流最大事件数量
AZURE_OPENAI_STREAM_ENABLE_USAGE_PARSING=true                  # 启用流使用解析
AZURE_OPENAI_STREAM_CHUNK_TIMEOUT=30000                        # 流块超时(毫秒) - 30秒

# 🌐 代理配置
DEFAULT_PROXY_TIMEOUT=60000
MAX_PROXY_RETRIES=3
# IP协议族配置：true=IPv4, false=IPv6, 默认IPv4（兼容性更好）
PROXY_USE_IPV4=true

# 📈 使用限制
DEFAULT_TOKEN_LIMIT=1000000

# 👥 用户管理配置 (User Management Configuration)
# ================================================================
# 主功能开关 - Master feature toggle
USER_MANAGEMENT_ENABLED=false                          # 启用用户管理功能 (默认禁用确保向后兼容)

# 用户注册设置 - User registration settings
ALLOW_SELF_REGISTRATION=false                          # 允许自注册
DEFAULT_USER_ROLE=user                                 # 默认用户角色
REQUIRE_EMAIL_VERIFICATION=false                       # 需要邮箱验证

# 密码策略配置 - Password policy configuration
PASSWORD_MIN_LENGTH=8                                  # 密码最小长度
PASSWORD_MAX_LENGTH=128                                # 密码最大长度
PASSWORD_REQUIRE_UPPERCASE=true                        # 需要大写字母
PASSWORD_REQUIRE_LOWERCASE=true                        # 需要小写字母
PASSWORD_REQUIRE_NUMBERS=true                          # 需要数字
PASSWORD_REQUIRE_SPECIAL_CHARS=false                   # 需要特殊字符
PASSWORD_PREVENT_COMMON=true                           # 防止常见密码
PASSWORD_MAX_CONSECUTIVE_CHARS=3                       # 最大连续相同字符

# 账户锁定设置 - Account lockout settings
ACCOUNT_LOCKOUT_ENABLED=true                           # 启用账户锁定
MAX_LOGIN_ATTEMPTS=5                                   # 最大失败登录次数
LOCKOUT_DURATION=30                                    # 锁定时长(分钟)
LOCKOUT_RESET_ON_SUCCESS=true                          # 成功登录后重置计数

# 会话管理 - Session management
USER_SESSION_TIMEOUT=3600                              # 用户会话超时(秒)
USER_SESSION_REFRESH_WINDOW=300                        # 会话刷新窗口(秒)
MAX_CONCURRENT_SESSIONS=3                              # 最大并发会话数
SESSION_CLEANUP_INTERVAL=900                           # 会话清理间隔(秒)

# 🔐 LDAP配置 (LDAP Configuration)
# ================================================================
# 主功能开关 - Master LDAP toggle
LDAP_ENABLED=false                                     # 启用LDAP认证 (默认禁用确保向后兼容)

# 连接设置 - Connection settings
LDAP_URL=ldap://localhost:389                          # LDAP服务器URL
LDAP_CONNECT_TIMEOUT=10000                             # 连接超时(毫秒)
LDAP_TIMEOUT=30000                                     # 操作超时(毫秒)
LDAP_RECONNECT=true                                    # 自动重连

# 认证设置 - Authentication settings
LDAP_BIND_DN=cn=admin,dc=example,dc=com                # 绑定DN
LDAP_BIND_PASSWORD=admin_password                      # 绑定密码

# 用户搜索配置 - User search configuration
LDAP_USER_SEARCH_BASE=ou=users,dc=example,dc=com       # 用户搜索基础DN
LDAP_USER_SEARCH_FILTER=(uid={{username}})             # 用户搜索过滤器
LDAP_USERNAME_ATTR=uid                                 # 用户名属性
LDAP_EMAIL_ATTR=mail                                   # 邮箱属性
LDAP_DISPLAY_NAME_ATTR=displayName                     # 显示名属性
LDAP_USER_ATTRIBUTES=uid,mail,displayName,memberOf     # 用户属性列表

# 组搜索配置 - Group search configuration
LDAP_GROUP_SEARCH_BASE=ou=groups,dc=example,dc=com     # 组搜索基础DN
LDAP_GROUP_SEARCH_FILTER=(member={{dn}})               # 组搜索过滤器
LDAP_GROUP_NAME_ATTR=cn                                # 组名属性
LDAP_GROUP_MEMBER_ATTR=member                          # 组成员属性

# 连接池配置 - Connection pool configuration
LDAP_POOL_MIN=1                                        # 最小连接数
LDAP_POOL_MAX=10                                       # 最大连接数
LDAP_POOL_ACQUIRE_TIMEOUT=10000                        # 获取连接超时(毫秒)
LDAP_POOL_IDLE_TIMEOUT=300000                          # 空闲连接超时(毫秒)

# 安全设置 - Security settings
LDAP_START_TLS=false                                   # 启用StartTLS
LDAP_VERIFY_CERT=true                                  # 验证证书
LDAP_CA_CERT_PATH=                                     # CA证书路径

# LDAP代理配置 - LDAP proxy configuration (可选)
LDAP_PROXY_ENABLED=false                               # 启用LDAP代理
LDAP_PROXY_HOST=                                       # 代理主机
LDAP_PROXY_PORT=1080                                   # 代理端口
LDAP_PROXY_TYPE=socks5                                 # 代理类型 (socks5|http)
LDAP_PROXY_USERNAME=                                   # 代理用户名
LDAP_PROXY_PASSWORD=                                   # 代理密码

# 📊 组调度配置 (Group Scheduling Configuration)
# ================================================================
# 主功能开关 - Master group scheduling toggle
GROUP_SCHEDULING_ENABLED=false                         # 启用组调度功能 (默认禁用确保向后兼容)

# 调度策略设置 - Scheduling strategy settings
GROUP_SCHEDULING_DEFAULT_STRATEGY=random               # 默认调度策略 (random|round_robin|weighted|priority|least_recent)
GROUP_SCHEDULING_FALLBACK_TO_GLOBAL=true               # 回退到全局账户

# 健康检查配置 - Health check configuration
GROUP_SCHEDULING_HEALTH_CHECK_ENABLED=true             # 启用健康检查
GROUP_SCHEDULING_HEALTH_CHECK_INTERVAL=30000           # 健康检查间隔(毫秒)
GROUP_SCHEDULING_HEALTH_CHECK_TIMEOUT=5000             # 健康检查超时(毫秒)
GROUP_SCHEDULING_HEALTH_CHECK_RETRY_COUNT=3            # 健康检查重试次数

# 缓存配置 - Cache configuration
GROUP_SCHEDULING_CACHE_GROUP_TTL=300                   # 组分配缓存TTL(秒)
GROUP_SCHEDULING_CACHE_GROUP_SIZE=1000                 # 组分配缓存最大条目数
GROUP_SCHEDULING_CACHE_HEALTH_TTL=60                   # 健康状态缓存TTL(秒)
GROUP_SCHEDULING_CACHE_HEALTH_SIZE=500                 # 健康状态缓存最大条目数

# 负载平衡配置 - Load balancing configuration
GROUP_SCHEDULING_ENABLE_WEIGHTS=true                   # 启用权重分配
GROUP_SCHEDULING_DEFAULT_WEIGHT=1.0                    # 默认权重
GROUP_SCHEDULING_MIN_WEIGHT=0.1                        # 最小权重
GROUP_SCHEDULING_MAX_WEIGHT=10.0                       # 最大权重

# Legacy 兼容配置 - Legacy compatibility settings
GROUP_LOAD_BALANCING_ENABLED=true                      # 启用负载平衡 (legacy)
MAX_USERS_PER_GROUP=100                                # 每组最大用户数 (legacy)
ROUND_ROBIN_ENABLED=true                               # 启用轮询算法 (legacy)
LEAST_ACTIVE_ENABLED=true                              # 启用最少活跃算法 (legacy)
LEAST_ACTIVE_WEIGHT=1.0                                # 最少活跃权重因子 (legacy)
WEIGHTED_SCHEDULING_ENABLED=false                      # 启用权重调度 (legacy)
DEFAULT_ACCOUNT_WEIGHT=1                               # 默认账户权重 (legacy)

# 🎯 调度策略配置 (Scheduling Configuration)
DEFAULT_SCHEDULING_STRATEGY=least_recent               # 默认调度策略
ENABLE_ACCOUNT_OVERRIDE=true                           # 允许账户级别覆盖
ENABLE_GROUP_OVERRIDE=true                             # 允许组级别覆盖

# 🔐 权限管理配置 (Permissions Configuration)
ENABLE_GROUP_ISOLATION=false                           # 启用组隔离
ENABLE_ACCOUNT_RESTRICTION=false                       # 启用账户限制

# 📝 日志配置
LOG_LEVEL=info
LOG_MAX_SIZE=10m
LOG_MAX_FILES=5

# 🔧 系统配置
CLEANUP_INTERVAL=3600000
TOKEN_USAGE_RETENTION=2592000000
HEALTH_CHECK_INTERVAL=60000
TIMEZONE_OFFSET=8  # UTC偏移小时数，默认+8（中国时区）
METRICS_WINDOW=5  # 实时指标统计窗口（分钟），可选1-60，默认5分钟

# 🎨 Web 界面配置
WEB_TITLE=Claude Relay Service
WEB_DESCRIPTION=Multi-account Claude API relay service with beautiful management interface
WEB_LOGO_URL=/assets/logo.png

# 🛠️ 开发配置
DEBUG=false
ENABLE_CORS=true
TRUST_PROXY=true

# 🔒 客户端限制（可选）
# ALLOW_CUSTOM_CLIENTS=false

# 📢 Webhook 通知配置
WEBHOOK_ENABLED=true
WEBHOOK_URLS=https://your-webhook-url.com/notify,https://backup-webhook.com/notify
WEBHOOK_TIMEOUT=10000
WEBHOOK_RETRIES=3

# 📊 API Key 请求日志记录配置
# Request Logging Configuration - 记录所有请求（简化版本）
# ================================================================

# 🔧 基础配置 (Basic Configuration)
REQUEST_LOGGING_ENABLED=false                 # 启用请求日志记录 (默认禁用确保向后兼容)
REQUEST_LOGGING_MODE=basic                    # 记录模式: basic | detailed | debug

# ⚡ 异步批量处理配置 (Async Batch Processing)
REQUEST_LOGGING_BATCH_SIZE=5                  # 批量写入大小 (默认5条，更快写入)
REQUEST_LOGGING_BATCH_TIMEOUT=2000            # 批量写入超时 (毫秒，默认2秒)
REQUEST_LOGGING_MAX_QUEUE_SIZE=1000           # 队列最大长度
REQUEST_LOGGING_QUEUE_FULL_STRATEGY=drop_oldest # 队列满时策略: drop_oldest | drop_newest | block
REQUEST_LOGGING_MAX_RETRIES=3                 # 写入失败重试次数
REQUEST_LOGGING_RETRY_DELAY=1000              # 重试间隔 (毫秒)

# 🗂️ 数据保留配置 (Data Retention Configuration)
REQUEST_LOGGING_RETENTION_DAYS=7              # 日志保留天数
REQUEST_LOGGING_CLEANUP_INTERVAL=21600000     # 自动清理间隔 (毫秒, 默认6小时)
REQUEST_LOGGING_MAX_LOGS_PER_KEY=10000        # 每个API Key最大日志数
REQUEST_LOGGING_MAX_TOTAL_LOGS=100000         # 总体最大日志数

# 💾 存储配置 (Storage Configuration)
REQUEST_LOGGING_KEY_PREFIX=request_log        # 日志键前缀
REQUEST_LOGGING_INDEX_KEY_PREFIX=request_log_index # 索引键前缀
REQUEST_LOGGING_STATS_KEY_PREFIX=request_log_stats # 统计键前缀
REQUEST_LOGGING_ENABLE_COMPRESSION=true       # 启用压缩存储
REQUEST_LOGGING_SERIALIZATION_FORMAT=json    # 序列化格式: json | msgpack

# 🛡️ 数据过滤配置 (Data Filtering Configuration)
REQUEST_LOGGING_MASK_IP=false                 # IP地址脱敏 (保留前三段)
REQUEST_LOGGING_MAX_UA_LENGTH=200             # User-Agent最大长度

# 📈 性能监控配置 (Performance Monitoring)
REQUEST_LOGGING_MONITORING_ENABLED=false     # 启用内部性能监控
REQUEST_LOGGING_METRICS_INTERVAL=60000       # 监控指标收集间隔 (毫秒)
REQUEST_LOGGING_METRICS_RETENTION=86400000   # 监控指标保留时间 (毫秒, 24小时)
REQUEST_LOGGING_QUEUE_WARNING_THRESHOLD=800  # 队列长度警告阈值
REQUEST_LOGGING_WRITE_WARNING_THRESHOLD=1000 # 写入延迟警告阈值 (毫秒)
REQUEST_LOGGING_MEMORY_WARNING_THRESHOLD=100 # 内存使用警告阈值 (MB)

# 🚀 高级功能配置 (Advanced Features Configuration)
REQUEST_LOGGING_ENABLE_REALTIME=false        # 启用实时日志流 (WebSocket)
REQUEST_LOGGING_ENABLE_EXPORT=true           # 启用日志导出功能
REQUEST_LOGGING_MAX_EXPORT_SIZE=50           # 导出文件大小限制 (MB)
REQUEST_LOGGING_ENABLE_SEARCH=true           # 启用日志搜索功能
REQUEST_LOGGING_SEARCH_INDEX_INTERVAL=300000 # 搜索索引更新频率 (毫秒, 5分钟)

# ===================================================================
# 🔧 未来数据库配置模板 (Future Database Configuration Templates)
# 以下配置为未来扩展预留，当前版本仅支持Redis
# The following configurations are reserved for future expansion, 
# current version only supports Redis
# ===================================================================

# 🍃 MongoDB 配置（未来支持）
# MongoDB Configuration (Future Support)
# MONGODB_URI=mongodb://localhost:27017
# MONGODB_DATABASE=claude_relay
# MONGODB_MAX_POOL_SIZE=10
# MONGODB_SERVER_SELECTION_TIMEOUT=5000
# MONGODB_SOCKET_TIMEOUT=45000
# # MongoDB 集合名称映射
# MONGODB_COLLECTION_API_KEYS=api_keys
# MONGODB_COLLECTION_CLAUDE_ACCOUNTS=claude_accounts
# MONGODB_COLLECTION_OPENAI_ACCOUNTS=openai_accounts
# MONGODB_COLLECTION_SESSIONS=sessions
# MONGODB_COLLECTION_USAGE_STATS=usage_stats
# MONGODB_COLLECTION_SYSTEM_STATS=system_stats
# MONGODB_COLLECTION_CONCURRENCY=concurrency

# 🐘 PostgreSQL 配置（未来支持）
# PostgreSQL Configuration (Future Support)
# POSTGRES_HOST=localhost
# POSTGRES_PORT=5432
# POSTGRES_DATABASE=claude_relay
# POSTGRES_USERNAME=claude_relay_user
# POSTGRES_PASSWORD=your-postgres-password
# POSTGRES_SSL=false
# # PostgreSQL 连接池配置
# POSTGRES_POOL_MAX=20
# POSTGRES_POOL_MIN=5
# POSTGRES_POOL_ACQUIRE=30000
# POSTGRES_POOL_IDLE=10000
# # PostgreSQL 表名映射
# POSTGRES_TABLE_API_KEYS=api_keys
# POSTGRES_TABLE_CLAUDE_ACCOUNTS=claude_accounts
# POSTGRES_TABLE_OPENAI_ACCOUNTS=openai_accounts
# POSTGRES_TABLE_SESSIONS=sessions
# POSTGRES_TABLE_USAGE_STATS=usage_stats
# POSTGRES_TABLE_SYSTEM_STATS=system_stats

# 🐬 MySQL 配置（未来支持）
# MySQL Configuration (Future Support)
# MYSQL_HOST=localhost
# MYSQL_PORT=3306
# MYSQL_DATABASE=claude_relay
# MYSQL_USERNAME=claude_relay_user
# MYSQL_PASSWORD=your-mysql-password
# MYSQL_CHARSET=utf8mb4
# # MySQL 连接池配置
# MYSQL_POOL_MAX=20
# MYSQL_POOL_MIN=5
# MYSQL_POOL_ACQUIRE=30000
# MYSQL_POOL_IDLE=10000
# # MySQL 表名映射
# MYSQL_TABLE_API_KEYS=api_keys
# MYSQL_TABLE_CLAUDE_ACCOUNTS=claude_accounts
# MYSQL_TABLE_OPENAI_ACCOUNTS=openai_accounts
# MYSQL_TABLE_SESSIONS=sessions
# MYSQL_TABLE_USAGE_STATS=usage_stats
# MYSQL_TABLE_SYSTEM_STATS=system_stats

# ===================================================================
# 📝 数据库配置说明 (Database Configuration Notes)
# ===================================================================
# 
# 1. 数据库类型选择 (Database Type Selection):
#    - redis: 当前默认，完全支持所有功能
#    - mongodb: 未来支持，适合大规模数据存储
#    - postgresql: 未来支持，适合复杂查询和事务
#    - mysql: 未来支持，适合传统关系型数据库需求
#
# 2. 配置优先级 (Configuration Priority):
#    - 环境变量 > 配置文件 > 默认值
#    - 向后兼容原有Redis配置
#
# 3. 生产环境建议 (Production Recommendations):
#    - 使用强密码和SSL/TLS连接
#    - 配置适当的连接池大小
#    - 定期备份数据库
#    - 监控数据库性能指标
#
# 4. 开发环境配置 (Development Configuration):
#    - 保持DATABASE_TYPE=redis使用默认配置
#    - 本地Redis实例无需密码
#    - 测试环境可使用内存数据库
# ===================================================================