import{aT as Ie,r as h,c as $}from"./vue-vendor-CcFZMz-v.js";import{b as R}from"./index-BZqqNmWF.js";import{s as m}from"./toast-BvwA7Mwb.js";const I=n=>{if(n==null||n==="")return 0;if(typeof n=="number"&&Number.isFinite(n))return n;const y=Number(n);return Number.isFinite(y)?y:0},Ke=(n={})=>{if(!n||typeof n!="object")return{totalTokens:0,inputTokens:0,outputTokens:0,cacheCreateTokens:0,cacheReadTokens:0,total_tokens:0,input_tokens:0,output_tokens:0,cache_creation_input_tokens:0,cache_read_input_tokens:0};const y=I(n.inputTokens??n.input_tokens??n.promptTokens??n.prompt_tokens),A=I(n.outputTokens??n.output_tokens??n.completionTokens??n.completion_tokens),D=I(n.cacheCreateTokens??n.cache_creation_input_tokens??n.cacheCreate??n.cache_create_tokens),f=I(n.cacheReadTokens??n.cache_read_input_tokens??n.cacheRead??n.cache_read_tokens);let g=I(n.totalTokens??n.total_tokens??n.total??n.tokens);return g||(g=y+A+D+f),{...n,totalTokens:g,inputTokens:y,outputTokens:A,cacheCreateTokens:D,cacheReadTokens:f,total_tokens:g,input_tokens:y,output_tokens:A,cache_creation_input_tokens:D,cache_read_input_tokens:f}},xe=Ie("requestLogs",()=>{const n=h([]),y=h(!1),A=h(!1),D=h({totalRequests:0,errorRate:0,averageResponseTime:0,topApiKeys:[]}),f=h([]),g=h(!1),C=h(null),K=h(null),b=h(0),_=h({apiKeyId:"",startDate:"",endDate:"",statusCode:"",method:"",search:"",page:1,limit:50,sortBy:"timestamp",sortOrder:"desc"}),q=h({page:1,limit:50,total:0,totalPages:0}),T=h({enabled:!1,mode:"performance",sampling:{successRate:.1,errorRate:1,slowRequestThreshold:5e3},retention:{days:30,maxEntries:1e5},async:{batchSize:50,flushInterval:2e3}}),S=h(!1),P=h(!1),ie=t=>{var s;if(!t||typeof t!="object")return t;const e=Ke(t.tokenDetails||t.tokenSummary||t.usage||{});t.tokenDetails=e;const a=e.totalTokens>0?Number((e.outputTokens/e.totalTokens*100).toFixed(2)):0;return t.tokenSummary={...t.tokenSummary||{},totalTokens:e.totalTokens,inputTokens:e.inputTokens,outputTokens:e.outputTokens,cacheCreateTokens:e.cacheCreateTokens,cacheReadTokens:e.cacheReadTokens,efficiency:((s=t.tokenSummary)==null?void 0:s.efficiency)??a},t},ue=t=>{if(!Array.isArray(t)||t.length===0)return[];const e=new Map,a=30*1e3;return t.forEach(s=>{let r;if(s.requestId)r=`req_${s.requestId}`;else{const u=new Date(s.timestamp||Date.now()).getTime(),l=Math.floor(u/a)*a;r=`${s.keyId||"unknown"}_${s.path||"/"}_${s.method||"GET"}_${l}`}if(e.has(r)){const u=e.get(r),l=le(u,s);e.set(r,l)}else e.set(r,{...s,_mergedCount:1,_originalIds:[s.id||s.logId||s.timestamp]})}),Array.from(e.values()).map(s=>ie(s)).sort((s,r)=>new Date(r.timestamp)-new Date(s.timestamp))},le=(t,e)=>{var s,r,u,l,p,c,k,v,o,i,d,E,z,N,U,W,G,X,V,Y,J,Q,Z,L,ee,te,se,ae,oe,ne,re,ce;const a={...t};return new Date(e.timestamp)>new Date(t.timestamp)&&(a.timestamp=e.timestamp,a.statusCode=e.statusCode||t.statusCode,a.responseTime=e.responseTime||t.responseTime),a.tokens=(a.tokens||0)+(e.tokens||0),a.inputTokens=(a.inputTokens||0)+(e.inputTokens||0),a.outputTokens=(a.outputTokens||0)+(e.outputTokens||0),a.cacheCreateTokens=(a.cacheCreateTokens||0)+(e.cacheCreateTokens||0),a.cacheReadTokens=(a.cacheReadTokens||0)+(e.cacheReadTokens||0),a.cost=(a.cost||0)+(e.cost||0),(e.tokenDetails||e.costDetails)&&(a.tokenDetails={totalTokens:(((s=a.tokenDetails)==null?void 0:s.totalTokens)||0)+(((r=e.tokenDetails)==null?void 0:r.totalTokens)||0),inputTokens:(((u=a.tokenDetails)==null?void 0:u.inputTokens)||0)+(((l=e.tokenDetails)==null?void 0:l.inputTokens)||0),outputTokens:(((p=a.tokenDetails)==null?void 0:p.outputTokens)||0)+(((c=e.tokenDetails)==null?void 0:c.outputTokens)||0),cacheCreateTokens:(((k=a.tokenDetails)==null?void 0:k.cacheCreateTokens)||0)+(((v=e.tokenDetails)==null?void 0:v.cacheCreateTokens)||0),cacheReadTokens:(((o=a.tokenDetails)==null?void 0:o.cacheReadTokens)||0)+(((i=e.tokenDetails)==null?void 0:i.cacheReadTokens)||0),cacheHitRatio:Math.max(((d=a.tokenDetails)==null?void 0:d.cacheHitRatio)||0,((E=e.tokenDetails)==null?void 0:E.cacheHitRatio)||0),tokenEfficiency:Math.max(((z=a.tokenDetails)==null?void 0:z.tokenEfficiency)||0,((N=e.tokenDetails)==null?void 0:N.tokenEfficiency)||0),ephemeral5mTokens:(((U=a.tokenDetails)==null?void 0:U.ephemeral5mTokens)||0)+(((W=e.tokenDetails)==null?void 0:W.ephemeral5mTokens)||0),ephemeral1hTokens:(((G=a.tokenDetails)==null?void 0:G.ephemeral1hTokens)||0)+(((X=e.tokenDetails)==null?void 0:X.ephemeral1hTokens)||0)},a.costDetails={totalCost:(((V=a.costDetails)==null?void 0:V.totalCost)||0)+(((Y=e.costDetails)==null?void 0:Y.totalCost)||0),costPerToken:((J=e.costDetails)==null?void 0:J.costPerToken)||((Q=a.costDetails)==null?void 0:Q.costPerToken)||0,currency:((Z=e.costDetails)==null?void 0:Z.currency)||((L=a.costDetails)==null?void 0:L.currency)||"USD"}),e.usage&&(a.usage={input_tokens:(((ee=a.usage)==null?void 0:ee.input_tokens)||0)+(((te=e.usage)==null?void 0:te.input_tokens)||0),output_tokens:(((se=a.usage)==null?void 0:se.output_tokens)||0)+(((ae=e.usage)==null?void 0:ae.output_tokens)||0),cache_creation_input_tokens:(((oe=a.usage)==null?void 0:oe.cache_creation_input_tokens)||0)+(((ne=e.usage)==null?void 0:ne.cache_creation_input_tokens)||0),cache_read_input_tokens:(((re=a.usage)==null?void 0:re.cache_read_input_tokens)||0)+(((ce=e.usage)==null?void 0:ce.cache_read_input_tokens)||0)}),e.requestHeaders&&Object.keys(e.requestHeaders).length>0&&(a.requestHeaders={...a.requestHeaders,...e.requestHeaders}),e.responseHeaders&&Object.keys(e.responseHeaders).length>0&&(a.responseHeaders={...a.responseHeaders,...e.responseHeaders}),e.requestBody&&!a.requestBody&&(a.requestBody=e.requestBody),e.responseBody&&!a.responseBody&&(a.responseBody=e.responseBody),a._mergedCount=(a._mergedCount||1)+1,a._originalIds=[...a._originalIds||[],e.id||e.logId||e.timestamp],a},de=$(()=>{const t=Array.isArray(n.value)?n.value:[];return ue(t)}),pe=$(()=>{const t=_.value;return t.apiKeyId||t.startDate||t.endDate||t.statusCode||t.method||t.search}),fe=$(()=>{const t=new Map;return Array.isArray(f.value)&&f.value.forEach(e=>{if(e&&e.id){const a={id:e.id,name:e.name||`API Key ${e.id}`,status:e.status||"unknown"};t.set(e.id,a)}}),t}),B=()=>{var s;if(!((s=f.value)!=null&&s.length)||C.value)return!0;const t=Date.now(),e=K.value,a=5*60*1e3;return!e||t-e>a},F=async(t=0)=>{var s,r,u,l,p,c,k,v;const a=[1e3,2e3,4e3];try{console.log(`[fetchApiKeys] 尝试获取 API Keys，重试次数: ${t}`);const o=await R.get("/admin/api-keys");if(!o)throw new Error("服务器响应为空");if(!o.success)throw new Error(o.message||`服务器返回错误状态: success=${o.success}`);if(!o.data)throw new Error("响应数据为空");let i=[];if(Array.isArray(o.data))i=o.data;else if(o.data.apiKeys&&Array.isArray(o.data.apiKeys))i=o.data.apiKeys;else if(typeof o.data=="object"&&Object.keys(o.data).length>0){const d=Object.values(o.data).filter(Array.isArray);d.length>0?i=d[0]:(console.warn("[fetchApiKeys] API Key 数据格式异常，无法解析数组:",o.data),i=[])}else console.warn("[fetchApiKeys] 未知的 API Key 数据格式:",o.data),i=[];return i=i.filter(d=>!d||typeof d!="object"?(console.warn("[fetchApiKeys] 跳过无效的 API Key 项:",d),!1):!0),i=i.map(d=>({id:d.id||d.keyId||d._id||null,name:d.name||d.keyName||`API Key ${d.id||"Unknown"}`,status:d.status||"active",...d})),f.value=i,C.value=null,K.value=Date.now(),b.value=0,console.log(`[fetchApiKeys] 成功获取 ${i.length} 个 API Keys`),{success:!0,data:i}}catch(o){if(console.error(`[fetchApiKeys] 获取失败 (重试 ${t}/3):`,{message:o.message,status:(s=o.response)==null?void 0:s.status,statusText:(r=o.response)==null?void 0:r.statusText,code:o.code,stack:(u=o.stack)==null?void 0:u.substring(0,200)}),t<3){const d=a[t]||4e3;return console.log(`[fetchApiKeys] ${d}ms 后进行第 ${t+1} 次重试...`),await new Promise(E=>setTimeout(E,d)),F(t+1)}C.value={message:o.message||"获取 API Key 列表失败",code:o.code||"FETCH_ERROR",status:((l=o.response)==null?void 0:l.status)||null,timestamp:Date.now(),retryCount:t},b.value=t;let i="获取 API Key 列表失败";throw o.code==="NETWORK_ERROR"||!navigator.onLine?i="网络连接失败，请检查网络后重试":((p=o.response)==null?void 0:p.status)===401?i="认证失败，请重新登录":((c=o.response)==null?void 0:c.status)===403?i="无权限访问 API Key 列表":((k=o.response)==null?void 0:k.status)>=500?i="服务器错误，请稍后重试":(v=o.message)!=null&&v.includes("timeout")&&(i="请求超时，请稍后重试"),m(i,"error"),o}},O=async(t=!1)=>{if(!t&&!B())return console.log("[fetchApiKeys] 使用缓存的 API Key 数据"),{success:!0,data:f.value,fromCache:!0};if(g.value){for(console.log("[fetchApiKeys] 正在加载中，等待完成...");g.value;)await new Promise(e=>setTimeout(e,100));return{success:!0,data:f.value,waited:!0}}g.value=!0;try{const e=await F(0);return e.success&&e.data&&(console.log("[fetchApiKeys] 设置API Key数据到响应式状态:",e.data.length),(!f.value||f.value.length!==e.data.length)&&(console.log("[fetchApiKeys] 重新设置apiKeyList.value"),f.value=e.data)),e}finally{g.value=!1}},me=()=>{f.value=[],C.value=null,K.value=null,b.value=0,console.log("[clearApiKeyCache] API Key 缓存已清除")},he=async()=>(console.log("[retryFetchApiKeys] 手动重试获取 API Keys"),C.value=null,O(!0)),x=async(t={})=>{console.log("🚀 fetchLogs方法被调用!",{params:t,filtersValue:_.value}),y.value=!0;try{const e={..._.value,...t},a={...e,keyId:e.apiKeyId,status:e.statusCode,startDate:e.startDate,endDate:e.endDate,method:e.method,search:e.search,page:e.page,limit:e.limit,sortBy:e.sortBy,sortOrder:e.sortOrder,apiKeyId:void 0,statusCode:void 0};Object.keys(a).forEach(r=>{(a[r]===void 0||a[r]==="")&&delete a[r]}),console.log("🔍 fetchLogs发送的参数:",a),console.log("🔍 原始filters状态:",_.value);const s=await R.get("/admin/request-logs",{params:a});return s&&s.success&&s.data&&(n.value=s.data.logs||[],q.value={page:s.data.page||1,limit:s.data.limit||50,total:s.data.total||0,totalPages:s.data.totalPages||0}),s}catch(e){throw console.error("Failed to fetch request logs:",e),m("获取请求日志失败","error"),e}finally{y.value=!1}},ye=async(t,e={})=>{y.value=!0;try{const a={...e},s=await R.get(`/admin/request-logs/${t}`,{params:a});return s&&s.success&&s.data&&(n.value=s.data.logs||[],q.value={page:s.data.page||1,limit:s.data.limit||50,total:s.data.total||0,totalPages:s.data.totalPages||0}),s}catch(a){throw console.error("Failed to fetch API key logs:",a),m("获取API Key日志失败","error"),a}finally{y.value=!1}},ke=async t=>{var e,a;if(!t)return console.warn("fetchLogDetails: logId为空"),null;try{console.log(`[fetchLogDetails] 获取日志详情: ${t}`);const s=await R.get(`/admin/request-logs/${t}/details`);return s&&s.success&&s.data?(console.log("[fetchLogDetails] 成功获取日志详情:",s.data),s.data):(console.warn("[fetchLogDetails] API返回失败:",s),null)}catch(s){throw console.error("Failed to fetch log details:",s),((e=s.response)==null?void 0:e.status)===404?m("日志记录不存在或已被删除","error"):((a=s.response)==null?void 0:a.status)===403?m("无权限查看此日志详情","error"):m("获取日志详情失败，请稍后重试","error"),s}},H=async(t="24h")=>{try{const e={};if(t==="24h"){const s=new Date,r=new Date(s.getTime()-24*60*60*1e3);e.startDate=r.toISOString(),e.endDate=s.toISOString()}else if(t==="7d"){const s=new Date,r=new Date(s.getTime()-7*24*60*60*1e3);e.startDate=r.toISOString(),e.endDate=s.toISOString()}const a=await R.get("/admin/request-logs/stats",{params:e});if(a&&a.success&&a.data){const s=a.data,r={totalRequests:s.totalRequests||0,errorRate:s.totalRequests>0?Object.entries(s.statusCodes||{}).filter(([u])=>u.startsWith("4")||u.startsWith("5")).reduce((u,[,l])=>u+l,0)/s.totalRequests*100:0,averageResponseTime:s.totalRequests>0?(s.totalResponseTime||0)/s.totalRequests:0,totalTokens:s.totalTokens||0,statusCodes:s.statusCodes||{},models:s.models||{},topApiKeys:Object.entries(s.apiKeys||{}).map(([u,l])=>({keyId:u,count:l})).sort((u,l)=>l.count-u.count).slice(0,5)};return D.value=r,{success:!0,data:r}}else{const s={totalRequests:0,errorRate:0,averageResponseTime:0,totalTokens:0,statusCodes:{},models:{},topApiKeys:[]};return D.value=s,{success:!0,data:s}}}catch(e){throw console.error("Failed to fetch log stats:",e),m("获取统计信息失败","error"),e}},ge=async t=>{try{const e=await R.delete(`/admin/request-logs/${t}`);return e&&e.success&&(m("日志删除成功","success"),await x()),e}catch(e){throw console.error("Failed to delete logs:",e),m("删除日志失败","error"),e}},Te=async(t="json",e={})=>{var a,s;A.value=!0;try{const r={..._.value,...e},u={format:t,...r,keyId:r.apiKeyId,status:r.statusCode,search:void 0,apiKeyId:void 0,statusCode:void 0};Object.keys(u).forEach(i=>{(u[i]===void 0||u[i]==="")&&delete u[i]}),m(`正在导出日志为 ${t.toUpperCase()} 格式...`,"info");const l=await R.get("/admin/request-logs/export",{params:u,responseType:"blob"});let p=`request-logs-${new Date().getTime()}.${t}`;const c=(s=(a=l.headers)==null?void 0:a.get)==null?void 0:s.call(a,"Content-Disposition");if(c){const i=c.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);i&&i[1]&&(p=i[1].replace(/['"]/g,""))}const k=l.data,v=window.URL.createObjectURL(k),o=document.createElement("a");return o.href=v,o.download=p,o.style.display="none",document.body.appendChild(o),o.click(),document.body.removeChild(o),window.URL.revokeObjectURL(v),m(`日志已成功导出为 ${t.toUpperCase()} 格式`,"success"),{success:!0,filename:p}}catch(r){console.error("Failed to export logs:",r);const u=r.message||"导出日志失败";throw m(u,"error"),r}finally{A.value=!1}},ve=async()=>{var t,e,a,s,r,u,l;S.value=!0;try{const p=await R.get("/admin/request-logs/config");if(p&&p.success&&p.data){const c=p.data;let k=30;typeof c.retentionDays=="number"?k=c.retentionDays:typeof c.retentionDays=="object"&&((t=c.retentionDays)!=null&&t.days)&&(k=c.retentionDays.days);const v={enabled:c.enabled||!1,mode:c.level==="debug"?"detailed":"performance",level:c.level||"info",retentionDays:k,maxFileSize:c.maxFileSize||10,maxFiles:c.maxFiles||10,includeHeaders:c.includeHeaders!==void 0?c.includeHeaders:!0,includeBody:c.includeBody!==void 0?c.includeBody:!0,includeResponse:c.includeResponse!==void 0?c.includeResponse:!0,includeErrors:c.includeErrors!==void 0?c.includeErrors:!0,filterSensitiveData:c.filterSensitiveData!==void 0?c.filterSensitiveData:!0,updatedAt:c.updatedAt,sampling:{successRate:((e=T.value.sampling)==null?void 0:e.successRate)||.1,errorRate:((a=T.value.sampling)==null?void 0:a.errorRate)||1,slowRequestThreshold:((s=T.value.sampling)==null?void 0:s.slowRequestThreshold)||5e3},retention:{days:k,maxEntries:((r=T.value.retention)==null?void 0:r.maxEntries)||1e5},async:{batchSize:((u=T.value.async)==null?void 0:u.batchSize)||50,flushInterval:((l=T.value.async)==null?void 0:l.flushInterval)||2e3}};T.value=v}return p}catch(p){throw m("加载配置失败","error"),p}finally{S.value=!1}},M=async t=>{P.value=!0;try{const e=await R.put("/admin/request-logs/config",t);return e&&e.success&&(T.value={...T.value,...e.data},m("配置保存成功","success")),e}catch(e){throw console.error("Failed to save request logging config:",e),m("保存配置失败","error"),e}finally{P.value=!1}},_e=async()=>await M({enabled:!1,mode:"performance",sampling:{successRate:.1,errorRate:1,slowRequestThreshold:5e3},retention:{days:30,maxEntries:1e5},async:{batchSize:50,flushInterval:2e3}}),Re=t=>{_.value={..._.value,...t}},Ae=()=>{_.value={apiKeyId:"",startDate:"",endDate:"",statusCode:"",method:"",search:"",page:1,limit:50,sortBy:"timestamp",sortOrder:"desc"}},De=async()=>{await x(),await H()},Ce=t=>({...t,timestamp:new Date(t.timestamp).toLocaleString("zh-CN"),duration:t.responseTime?`${t.responseTime}ms`:"N/A",statusClass:j(t.statusCode),methodClass:w(t.method)}),j=t=>{const e=parseInt(t);return e?e>=200&&e<300?"text-green-600":e>=300&&e<400?"text-yellow-600":e>=400&&e<500?"text-orange-600":e>=500?"text-red-600":"text-gray-500":"text-gray-500"},w=t=>({GET:"text-blue-600",POST:"text-green-600",PUT:"text-yellow-600",DELETE:"text-red-600",PATCH:"text-purple-600"})[t]||"text-gray-600";return{logs:n,loading:y,exporting:A,stats:D,filters:_,pagination:q,config:T,configLoading:S,configSaving:P,apiKeyList:f,apiKeyLoading:g,apiKeyError:C,apiKeyLoadTime:K,apiKeyRetryCount:b,filteredLogs:de,hasFilters:pe,apiKeyMap:fe,fetchApiKeys:O,clearApiKeyCache:me,retryFetchApiKeys:he,shouldRefreshApiKeys:B,fetchLogs:x,fetchLogsByApiKey:ye,fetchLogDetails:ke,fetchStats:H,deleteLogsByApiKey:ge,exportLogs:Te,refreshLogs:De,loadConfig:ve,saveConfig:M,resetConfig:_e,updateFilters:Re,clearFilters:Ae,formatLogEntry:Ce,getStatusClass:j,getMethodClass:w,formatBytes:t=>{if(t===0)return"0 B";const e=1024,a=["B","KB","MB","GB"],s=Math.floor(Math.log(t)/Math.log(e));return parseFloat((t/Math.pow(e,s)).toFixed(2))+" "+a[s]},formatDuration:t=>t<1e3?`${t}ms`:t<6e4?`${(t/1e3).toFixed(1)}s`:`${(t/6e4).toFixed(1)}m`}});export{Ke as n,xe as u};
