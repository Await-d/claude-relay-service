import{r as i,c as l,o as p,q as X,V as Y,x as u,y as c,L as g,C as N,z as t,P as S,Y as G,O as d,aX as H}from"./vue-vendor-CcFZMz-v.js";import{_ as J}from"./index-DCzasIW1.js";const K={class:"session-manager"},Q={key:0,class:"ml-2 text-sm"},W={class:"glass-strong w-full max-w-md rounded-2xl p-6 shadow-2xl"},Z={class:"mb-4 text-center"},ee={class:"mt-2 text-sm text-gray-600 dark:text-gray-400"},se={class:"flex space-x-3"},te=["disabled"],ae=["disabled"],re={key:0,class:"loading-spinner mr-2"},le={key:1,class:"fas fa-refresh mr-2"},ne={key:2,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm"},oe={__name:"SessionManager",props:{sessionToken:{type:String,default:""},expiresAt:{type:[String,Number],default:null},autoRefresh:{type:Boolean,default:!0},refreshThreshold:{type:Number,default:5*60*1e3},showIndicator:{type:Boolean,default:!1},showStatusText:{type:Boolean,default:!1}},emits:["sessionRefreshed","sessionExpired","refreshFailed","logout"],setup(y,{expose:z,emit:V}){const a=y,x=V,U=H(),r=i(!1),k=i(!1),b=i(!1),C=i(Date.now()),n=i(null),o=i(null),$=i(0),v=l(()=>a.expiresAt?typeof a.expiresAt=="string"?new Date(a.expiresAt).getTime():a.expiresAt:null),f=l(()=>v.value?Math.max(0,v.value-C.value):0),w=l(()=>f.value<=0),A=l(()=>f.value>0&&f.value<=a.refreshThreshold),m=l(()=>a.sessionToken?w.value?"expired":A.value?"expiring":"active":"none"),j=l(()=>{const e="session-indicator";switch(m.value){case"active":return`${e} text-green-600 dark:text-green-400`;case"expiring":return`${e} text-yellow-600 dark:text-yellow-400`;case"expired":return`${e} text-red-600 dark:text-red-400`;default:return`${e} text-gray-500`}}),q=l(()=>{switch(m.value){case"active":return"fas fa-check-circle";case"expiring":return"fas fa-clock";case"expired":return"fas fa-times-circle";default:return"fas fa-question-circle"}}),F=l(()=>{switch(m.value){case"active":return"会话正常";case"expiring":return`${T(f.value)}后过期`;case"expired":return"会话已过期";default:return"未登录"}}),T=e=>{const s=Math.floor(e/1e3),h=Math.floor(s/60),D=Math.floor(h/60);return D>0?`${D}小时${h%60}分钟`:h>0?`${h}分钟${s%60}秒`:`${s}秒`},E=()=>{o.value&&clearInterval(o.value),o.value=setInterval(()=>{C.value=Date.now()},1e3)},I=()=>{o.value&&(clearInterval(o.value),o.value=null)},_=()=>{if(n.value&&clearTimeout(n.value),!v.value||!a.autoRefresh)return;const e=Math.max(0,v.value-Date.now()-a.refreshThreshold);e>0&&(n.value=setTimeout(()=>{B()},e))},B=async()=>{if(r.value||w.value)return;const e=Date.now();if(!(e-$.value<3e4)){$.value=e;try{r.value=!0,await R()}catch(s){console.error("Auto refresh failed:",s),k.value=!0}finally{r.value=!1}}},R=async()=>{if(!a.sessionToken)throw new Error("No session token available");x("sessionRefreshed")},L=async()=>{try{r.value=!0,await R(),M()}catch(e){console.error("Manual refresh failed:",e),x("refreshFailed",e)}finally{r.value=!1}},M=()=>{k.value=!1},O=()=>{M(),x("logout")},P=()=>{b.value=!1,U.push("/login")};return p(()=>a.sessionToken,(e,s)=>{e!==s&&(e?(_(),o.value||E()):(I(),n.value&&clearTimeout(n.value)))},{immediate:!0}),p(()=>a.expiresAt,()=>{_()}),p(w,e=>{e&&a.sessionToken&&(b.value=!0,x("sessionExpired"))}),p(A,e=>{e&&a.autoRefresh&&!r.value&&B()}),X(()=>{a.sessionToken&&(E(),_())}),Y(()=>{I(),n.value&&clearTimeout(n.value)}),z({refreshSession:R,formatTime:T,timeUntilExpiry:f,sessionStatus:m}),(e,s)=>(c(),u("div",K,[y.showIndicator?(c(),u("div",{key:0,class:N(["session-indicator",j.value])},[t("i",{class:N(["text-sm",q.value])},null,2),y.showStatusText?(c(),u("span",Q,S(F.value),1)):g("",!0)],2)):g("",!0),k.value?(c(),u("div",{key:1,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm",onClick:G(M,["self"])},[t("div",W,[t("div",Z,[s[2]||(s[2]=t("i",{class:"fas fa-clock mb-3 text-3xl text-yellow-500"},null,-1)),s[3]||(s[3]=t("h3",{class:"text-lg font-semibold text-gray-900 dark:text-gray-100"},"会话即将过期",-1)),t("p",ee,[s[0]||(s[0]=d(" 您的会话将在 ",-1)),t("strong",null,S(T(f.value)),1),s[1]||(s[1]=d(" 后过期。 是否要刷新会话？ ",-1))])]),t("div",se,[t("button",{class:"btn btn-outline flex-1",disabled:r.value,onClick:O},[...s[4]||(s[4]=[t("i",{class:"fas fa-sign-out-alt mr-2"},null,-1),d(" 登出 ",-1)])],8,te),t("button",{class:"btn btn-primary flex-1",disabled:r.value,onClick:L},[r.value?(c(),u("div",re)):(c(),u("i",le)),d(" "+S(r.value?"刷新中...":"刷新会话"),1)],8,ae)])])])):g("",!0),b.value?(c(),u("div",ne,[t("div",{class:"glass-strong w-full max-w-md rounded-2xl p-6 shadow-2xl"},[s[6]||(s[6]=t("div",{class:"mb-6 text-center"},[t("i",{class:"fas fa-exclamation-triangle mb-3 text-3xl text-red-500"}),t("h3",{class:"text-lg font-semibold text-gray-900 dark:text-gray-100"},"会话已过期"),t("p",{class:"mt-2 text-sm text-gray-600 dark:text-gray-400"},"您的会话已过期，请重新登录。")],-1)),t("button",{class:"btn btn-primary w-full",onClick:P},[...s[5]||(s[5]=[t("i",{class:"fas fa-sign-in-alt mr-2"},null,-1),d(" 重新登录 ",-1)])])])])):g("",!0)]))}},ce=J(oe,[["__scopeId","data-v-d50be828"]]);export{ce as S};
