import{aR as te,r as f,c as L}from"./vue-vendor-Ig-GgGwA.js";import{b as v}from"./index-Dc6MCwet.js";import{s as y}from"./toast-BvwA7Mwb.js";const le=te("requestLogs",()=>{const R=f([]),K=f(!1),C=f(!1),E=f({totalRequests:0,errorRate:0,averageResponseTime:0,topApiKeys:[]}),p=f([]),I=f(!1),A=f(null),D=f(null),T=f(0),m=f({apiKeyId:"",startDate:"",endDate:"",statusCode:"",method:"",search:"",page:1,limit:50,sortBy:"timestamp",sortOrder:"desc"}),b=f({page:1,limit:50,total:0,totalPages:0}),g=f({enabled:!1,mode:"performance",sampling:{successRate:.1,errorRate:1,slowRequestThreshold:5e3},retention:{days:30,maxEntries:1e5},async:{batchSize:50,flushInterval:2e3}}),x=f(!1),P=f(!1),j=L(()=>{const t=Array.isArray(R.value)?R.value:[];if(!m.value.search)return t;const e=m.value.search.toLowerCase();return t.filter(r=>{var s,o,i,u;return((s=r.keyName)==null?void 0:s.toLowerCase().includes(e))||((o=r.userAgent)==null?void 0:o.toLowerCase().includes(e))||((i=r.ipAddress)==null?void 0:i.includes(e))||((u=r.path)==null?void 0:u.toLowerCase().includes(e))})}),U=L(()=>{const t=m.value;return t.apiKeyId||t.startDate||t.endDate||t.statusCode||t.method||t.search}),z=L(()=>{const t=new Map;return Array.isArray(p.value)&&p.value.forEach(e=>{if(e&&e.id){const r={id:e.id,name:e.name||`API Key ${e.id}`,status:e.status||"unknown"};t.set(e.id,r)}}),t}),q=()=>{var s;if(!((s=p.value)!=null&&s.length)||A.value)return!0;const t=Date.now(),e=D.value,r=5*60*1e3;return!e||t-e>r},k=async(t=0)=>{var s,o,i,u,d,n,h,w;const r=[1e3,2e3,4e3];try{console.log(`[fetchApiKeys] 尝试获取 API Keys，重试次数: ${t}`);const a=await v.get("/admin/api-keys");if(!a)throw new Error("服务器响应为空");if(!a.success)throw new Error(a.message||`服务器返回错误状态: success=${a.success}`);if(!a.data)throw new Error("响应数据为空");let l=[];if(Array.isArray(a.data))l=a.data;else if(a.data.apiKeys&&Array.isArray(a.data.apiKeys))l=a.data.apiKeys;else if(typeof a.data=="object"&&Object.keys(a.data).length>0){const c=Object.values(a.data).filter(Array.isArray);c.length>0?l=c[0]:(console.warn("[fetchApiKeys] API Key 数据格式异常，无法解析数组:",a.data),l=[])}else console.warn("[fetchApiKeys] 未知的 API Key 数据格式:",a.data),l=[];return l=l.filter(c=>!c||typeof c!="object"?(console.warn("[fetchApiKeys] 跳过无效的 API Key 项:",c),!1):!0),l=l.map(c=>({id:c.id||c.keyId||c._id||null,name:c.name||c.keyName||`API Key ${c.id||"Unknown"}`,status:c.status||"active",...c})),p.value=l,A.value=null,D.value=Date.now(),T.value=0,console.log(`[fetchApiKeys] 成功获取 ${l.length} 个 API Keys`),{success:!0,data:l}}catch(a){if(console.error(`[fetchApiKeys] 获取失败 (重试 ${t}/3):`,{message:a.message,status:(s=a.response)==null?void 0:s.status,statusText:(o=a.response)==null?void 0:o.statusText,code:a.code,stack:(i=a.stack)==null?void 0:i.substring(0,200)}),t<3){const c=r[t]||4e3;return console.log(`[fetchApiKeys] ${c}ms 后进行第 ${t+1} 次重试...`),await new Promise(ee=>setTimeout(ee,c)),k(t+1)}A.value={message:a.message||"获取 API Key 列表失败",code:a.code||"FETCH_ERROR",status:((u=a.response)==null?void 0:u.status)||null,timestamp:Date.now(),retryCount:t},T.value=t;let l="获取 API Key 列表失败";throw a.code==="NETWORK_ERROR"||!navigator.onLine?l="网络连接失败，请检查网络后重试":((d=a.response)==null?void 0:d.status)===401?l="认证失败，请重新登录":((n=a.response)==null?void 0:n.status)===403?l="无权限访问 API Key 列表":((h=a.response)==null?void 0:h.status)>=500?l="服务器错误，请稍后重试":(w=a.message)!=null&&w.includes("timeout")&&(l="请求超时，请稍后重试"),y(l,"error"),a}},F=async(t=!1)=>{if(!t&&!q())return console.log("[fetchApiKeys] 使用缓存的 API Key 数据"),{success:!0,data:p.value,fromCache:!0};if(I.value){for(console.log("[fetchApiKeys] 正在加载中，等待完成...");I.value;)await new Promise(e=>setTimeout(e,100));return{success:!0,data:p.value,waited:!0}}I.value=!0;try{const e=await k(0);return e.success&&e.data&&(console.log("[fetchApiKeys] 设置API Key数据到响应式状态:",e.data.length),(!p.value||p.value.length!==e.data.length)&&(console.log("[fetchApiKeys] 重新设置apiKeyList.value"),p.value=e.data)),e}finally{I.value=!1}},_=()=>{p.value=[],A.value=null,D.value=null,T.value=0,console.log("[clearApiKeyCache] API Key 缓存已清除")},H=async()=>(console.log("[retryFetchApiKeys] 手动重试获取 API Keys"),A.value=null,F(!0)),S=async(t={})=>{K.value=!0;try{const e={...m.value,...t},r={...e,keyId:e.apiKeyId,status:e.statusCode,search:void 0,apiKeyId:void 0,statusCode:void 0};Object.keys(r).forEach(o=>{(r[o]===void 0||r[o]==="")&&delete r[o]});const s=await v.get("/admin/request-logs",{params:r});return s&&s.success&&s.data&&(R.value=s.data.logs||[],b.value={page:s.data.page||1,limit:s.data.limit||50,total:s.data.total||0,totalPages:s.data.totalPages||0}),s}catch(e){throw console.error("Failed to fetch request logs:",e),y("获取请求日志失败","error"),e}finally{K.value=!1}},N=async(t,e={})=>{K.value=!0;try{const r={...e},s=await v.get(`/admin/request-logs/${t}`,{params:r});return s&&s.success&&s.data&&(R.value=s.data.logs||[],b.value={page:s.data.page||1,limit:s.data.limit||50,total:s.data.total||0,totalPages:s.data.totalPages||0}),s}catch(r){throw console.error("Failed to fetch API key logs:",r),y("获取API Key日志失败","error"),r}finally{K.value=!1}},O=async(t="24h")=>{try{const e={};if(t==="24h"){const s=new Date,o=new Date(s.getTime()-24*60*60*1e3);e.startDate=o.toISOString(),e.endDate=s.toISOString()}else if(t==="7d"){const s=new Date,o=new Date(s.getTime()-7*24*60*60*1e3);e.startDate=o.toISOString(),e.endDate=s.toISOString()}const r=await v.get("/admin/request-logs/stats",{params:e});if(r&&r.success&&r.data){const s=r.data,o={totalRequests:s.totalRequests||0,errorRate:s.totalRequests>0?Object.entries(s.statusCodes||{}).filter(([i])=>i.startsWith("4")||i.startsWith("5")).reduce((i,[,u])=>i+u,0)/s.totalRequests*100:0,averageResponseTime:s.totalRequests>0?(s.totalResponseTime||0)/s.totalRequests:0,totalTokens:s.totalTokens||0,statusCodes:s.statusCodes||{},models:s.models||{},topApiKeys:Object.entries(s.apiKeys||{}).map(([i,u])=>({keyId:i,count:u})).sort((i,u)=>u.count-i.count).slice(0,5)};return E.value=o,{success:!0,data:o}}else{const s={totalRequests:0,errorRate:0,averageResponseTime:0,totalTokens:0,statusCodes:{},models:{},topApiKeys:[]};return E.value=s,{success:!0,data:s}}}catch(e){throw console.error("Failed to fetch log stats:",e),y("获取统计信息失败","error"),e}},W=async t=>{try{const e=await v.delete(`/admin/request-logs/${t}`);return e&&e.success&&(y("日志删除成功","success"),await S()),e}catch(e){throw console.error("Failed to delete logs:",e),y("删除日志失败","error"),e}},X=async(t="json",e={})=>{var r,s;C.value=!0;try{const o={...m.value,...e},i={format:t,...o,keyId:o.apiKeyId,status:o.statusCode,search:void 0,apiKeyId:void 0,statusCode:void 0};Object.keys(i).forEach(l=>{(i[l]===void 0||i[l]==="")&&delete i[l]}),y(`正在导出日志为 ${t.toUpperCase()} 格式...`,"info");const u=await v.get("/admin/request-logs/export",{params:i,responseType:"blob"});let d=`request-logs-${new Date().getTime()}.${t}`;const n=(s=(r=u.headers)==null?void 0:r.get)==null?void 0:s.call(r,"Content-Disposition");if(n){const l=n.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);l&&l[1]&&(d=l[1].replace(/['"]/g,""))}const h=u.data,w=window.URL.createObjectURL(h),a=document.createElement("a");return a.href=w,a.download=d,a.style.display="none",document.body.appendChild(a),a.click(),document.body.removeChild(a),window.URL.revokeObjectURL(w),y(`日志已成功导出为 ${t.toUpperCase()} 格式`,"success"),{success:!0,filename:d}}catch(o){console.error("Failed to export logs:",o);const i=o.message||"导出日志失败";throw y(i,"error"),o}finally{C.value=!1}},G=async()=>{var t,e,r,s,o,i,u;x.value=!0;try{const d=await v.get("/admin/request-logs/config");if(d&&d.success&&d.data){const n=d.data;let h=30;typeof n.retentionDays=="number"?h=n.retentionDays:typeof n.retentionDays=="object"&&((t=n.retentionDays)!=null&&t.days)&&(h=n.retentionDays.days);const w={enabled:n.enabled||!1,mode:n.level==="debug"?"detailed":"performance",level:n.level||"info",retentionDays:h,maxFileSize:n.maxFileSize||10,maxFiles:n.maxFiles||10,includeHeaders:n.includeHeaders!==void 0?n.includeHeaders:!0,includeBody:n.includeBody!==void 0?n.includeBody:!0,includeResponse:n.includeResponse!==void 0?n.includeResponse:!0,includeErrors:n.includeErrors!==void 0?n.includeErrors:!0,filterSensitiveData:n.filterSensitiveData!==void 0?n.filterSensitiveData:!0,updatedAt:n.updatedAt,sampling:{successRate:((e=g.value.sampling)==null?void 0:e.successRate)||.1,errorRate:((r=g.value.sampling)==null?void 0:r.errorRate)||1,slowRequestThreshold:((s=g.value.sampling)==null?void 0:s.slowRequestThreshold)||5e3},retention:{days:h,maxEntries:((o=g.value.retention)==null?void 0:o.maxEntries)||1e5},async:{batchSize:((i=g.value.async)==null?void 0:i.batchSize)||50,flushInterval:((u=g.value.async)==null?void 0:u.flushInterval)||2e3}};g.value=w}return d}catch(d){throw y("加载配置失败","error"),d}finally{x.value=!1}},$=async t=>{P.value=!0;try{const e=await v.put("/admin/request-logs/config",t);return e&&e.success&&(g.value={...g.value,...e.data},y("配置保存成功","success")),e}catch(e){throw console.error("Failed to save request logging config:",e),y("保存配置失败","error"),e}finally{P.value=!1}},Y=async()=>await $({enabled:!1,mode:"performance",sampling:{successRate:.1,errorRate:1,slowRequestThreshold:5e3},retention:{days:30,maxEntries:1e5},async:{batchSize:50,flushInterval:2e3}}),V=t=>{m.value={...m.value,...t}},J=()=>{m.value={apiKeyId:"",startDate:"",endDate:"",statusCode:"",method:"",search:"",page:1,limit:50,sortBy:"timestamp",sortOrder:"desc"}},Q=async()=>{await S(),await O()},Z=t=>({...t,timestamp:new Date(t.timestamp).toLocaleString("zh-CN"),duration:t.responseTime?`${t.responseTime}ms`:"N/A",statusClass:B(t.statusCode),methodClass:M(t.method)}),B=t=>{const e=parseInt(t);return e?e>=200&&e<300?"text-green-600":e>=300&&e<400?"text-yellow-600":e>=400&&e<500?"text-orange-600":e>=500?"text-red-600":"text-gray-500":"text-gray-500"},M=t=>({GET:"text-blue-600",POST:"text-green-600",PUT:"text-yellow-600",DELETE:"text-red-600",PATCH:"text-purple-600"})[t]||"text-gray-600";return{logs:R,loading:K,exporting:C,stats:E,filters:m,pagination:b,config:g,configLoading:x,configSaving:P,apiKeyList:p,apiKeyLoading:I,apiKeyError:A,apiKeyLoadTime:D,apiKeyRetryCount:T,filteredLogs:j,hasFilters:U,apiKeyMap:z,fetchApiKeys:F,clearApiKeyCache:_,retryFetchApiKeys:H,shouldRefreshApiKeys:q,fetchLogs:S,fetchLogsByApiKey:N,fetchStats:O,deleteLogsByApiKey:W,exportLogs:X,refreshLogs:Q,loadConfig:G,saveConfig:$,resetConfig:Y,updateFilters:V,clearFilters:J,formatLogEntry:Z,getStatusClass:B,getMethodClass:M,formatBytes:t=>{if(t===0)return"0 B";const e=1024,r=["B","KB","MB","GB"],s=Math.floor(Math.log(t)/Math.log(e));return parseFloat((t/Math.pow(e,s)).toFixed(2))+" "+r[s]},formatDuration:t=>t<1e3?`${t}ms`:t<6e4?`${(t/1e3).toFixed(1)}s`:`${(t/6e4).toFixed(1)}m`}});export{le as u};
